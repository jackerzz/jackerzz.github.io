<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Patroni 3.0和CSUTS：可扩展、高度可用的Postgres | Jacker-zzk's Blog</title><meta name="keywords" content="PostgreSQL"><meta name="author" content="Jackerzz-zzk"><meta name="copyright" content="Jackerzz-zzk"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Dockerfile and Dockerfile.citusYou can run Patroni in a docker container using these Dockerfiles They are meant in aiding development of Patroni and quick testing of features and not a production-wort"><meta property="og:type" content="article"><meta property="og:title" content="Patroni 3.0和CSUTS：可扩展、高度可用的Postgres"><meta property="og:url" content="https://jackerzz.github.io/posts/devops/ha/patroni_citus_ha.html"><meta property="og:site_name" content="Jacker-zzk&#39;s Blog"><meta property="og:description" content="Dockerfile and Dockerfile.citusYou can run Patroni in a docker container using these Dockerfiles They are meant in aiding development of Patroni and quick testing of features and not a production-wort"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/3244513.jpg"><meta property="article:published_time" content="2023-07-21T14:30:34.000Z"><meta property="article:modified_time" content="2023-07-29T13:30:45.547Z"><meta property="article:author" content="Jackerzz-zzk"><meta property="article:tag" content="PostgreSQL"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/3244513.jpg"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@sion1.0/images/img/bookgirl_ico.jpg"><link rel="canonical" href="https://jackerzz.github.io/posts/devops/ha/patroni_citus_ha"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:200},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Patroni 3.0和CSUTS：可扩展、高度可用的Postgres",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-07-29 21:30:45"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@sion1.0/images/avatar/35586448.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">158</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">34</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>文章分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/3244513.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jacker-zzk's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>文章分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Patroni 3.0和CSUTS：可扩展、高度可用的Postgres</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-21T14:30:34.000Z" title="发表于 2023-07-21 22:30:34">2023-07-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-07-29T13:30:45.547Z" title="更新于 2023-07-29 21:30:45">2023-07-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/">开发笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="Patroni 3.0和CSUTS：可扩展、高度可用的Postgres"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Dockerfile-and-Dockerfile-citus"><a href="#Dockerfile-and-Dockerfile-citus" class="headerlink" title="Dockerfile and Dockerfile.citus"></a>Dockerfile and Dockerfile.citus</h1><p>You can run Patroni in a docker container using these Dockerfiles</p><p>They are meant in aiding development of Patroni and quick testing of features and not a production-worthy!</p><pre><code>docker build -t patroni .
docker build -f Dockerfile.citus -t patroni-citus .
</code></pre><h1 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h1><h2 id="Standalone-Patroni"><a href="#Standalone-Patroni" class="headerlink" title="Standalone Patroni"></a>Standalone Patroni</h2><pre><code>docker run -d patroni
</code></pre><h2 id="Three-node-Patroni-cluster"><a href="#Three-node-Patroni-cluster" class="headerlink" title="Three-node Patroni cluster"></a>Three-node Patroni cluster</h2><p>In addition to three Patroni containers the stack starts three containers with etcd (forming a three-node cluster), and one container with haproxy.<br>The haproxy listens on ports 5000 (connects to the primary) and 5001 (does load-balancing between healthy standbys).</p><p>Example session:</p><pre><code>$ docker-compose up -d
Creating demo-haproxy ...
Creating demo-patroni2 ...
Creating demo-patroni1 ...
Creating demo-patroni3 ...
Creating demo-etcd2 ...
Creating demo-etcd1 ...
Creating demo-etcd3 ...
Creating demo-haproxy
Creating demo-patroni2
Creating demo-patroni1
Creating demo-patroni3
Creating demo-etcd1
Creating demo-etcd2
Creating demo-etcd2 ... done

$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                              NAMES
5b7a90b4cfbf        patroni             &quot;/bin/sh /entrypoint…&quot;   29 seconds ago      Up 27 seconds                                          demo-etcd2
e30eea5222f2        patroni             &quot;/bin/sh /entrypoint…&quot;   29 seconds ago      Up 27 seconds                                          demo-etcd1
83bcf3cb208f        patroni             &quot;/bin/sh /entrypoint…&quot;   29 seconds ago      Up 27 seconds                                          demo-etcd3
922532c56e7d        patroni             &quot;/bin/sh /entrypoint…&quot;   29 seconds ago      Up 28 seconds                                          demo-patroni3
14f875e445f3        patroni             &quot;/bin/sh /entrypoint…&quot;   29 seconds ago      Up 28 seconds                                          demo-patroni2
110d1073b383        patroni             &quot;/bin/sh /entrypoint…&quot;   29 seconds ago      Up 28 seconds                                          demo-patroni1
5af5e6e36028        patroni             &quot;/bin/sh /entrypoint…&quot;   29 seconds ago      Up 28 seconds       0.0.0.0:5000-5001-&gt;5000-5001/tcp   demo-haproxy

$ docker logs demo-patroni1
2019-02-20 08:19:32,714 INFO: Failed to import patroni.dcs.consul
2019-02-20 08:19:32,737 INFO: Selected new etcd server http://etcd3:2379
2019-02-20 08:19:35,140 INFO: Lock owner: None; I am patroni1
2019-02-20 08:19:35,174 INFO: trying to bootstrap a new cluster
...
2019-02-20 08:19:39,310 INFO: postmaster pid=37
2019-02-20 08:19:39.314 UTC [37] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432
2019-02-20 08:19:39.321 UTC [37] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;
2019-02-20 08:19:39.353 UTC [39] LOG:  database system was shut down at 2019-02-20 08:19:36 UTC
2019-02-20 08:19:39.354 UTC [40] FATAL:  the database system is starting up
localhost:5432 - rejecting connections
2019-02-20 08:19:39.369 UTC [37] LOG:  database system is ready to accept connections
localhost:5432 - accepting connections
2019-02-20 08:19:39,383 INFO: establishing a new patroni connection to the postgres cluster
2019-02-20 08:19:39,408 INFO: running post_bootstrap
2019-02-20 08:19:39,432 WARNING: Could not activate Linux watchdog device: &quot;Can&#39;t open watchdog device: [Errno 2] No such file or directory: &#39;/dev/watchdog&#39;&quot;
2019-02-20 08:19:39,515 INFO: initialized a new cluster
2019-02-20 08:19:49,424 INFO: Lock owner: patroni1; I am patroni1
2019-02-20 08:19:49,447 INFO: Lock owner: patroni1; I am patroni1
2019-02-20 08:19:49,480 INFO: no action.  i am the leader with the lock
2019-02-20 08:19:59,422 INFO: Lock owner: patroni1; I am patroni1

$ docker exec -ti demo-patroni1 bash
postgres@patroni1:~$ patronictl list
+---------+----------+------------+--------+---------+----+-----------+
| Cluster |  Member  |    Host    |  Role  |  State  | TL | Lag in MB |
+---------+----------+------------+--------+---------+----+-----------+
|   demo  | patroni1 | 172.22.0.3 | Leader | running |  1 |         0 |
|   demo  | patroni2 | 172.22.0.7 |        | running |  1 |         0 |
|   demo  | patroni3 | 172.22.0.4 |        | running |  1 |         0 |
+---------+----------+------------+--------+---------+----+-----------+

postgres@patroni1:~$ etcdctl ls --recursive --sort -p /service/demo
/service/demo/config
/service/demo/initialize
/service/demo/leader
/service/demo/members/
/service/demo/members/patroni1
/service/demo/members/patroni2
/service/demo/members/patroni3
/service/demo/optime/
/service/demo/optime/leader

postgres@patroni1:~$ etcdctl member list
1bab629f01fa9065: name=etcd3 peerURLs=http://etcd3:2380 clientURLs=http://etcd3:2379 isLeader=false
8ecb6af518d241cc: name=etcd2 peerURLs=http://etcd2:2380 clientURLs=http://etcd2:2379 isLeader=true
b2e169fcb8a34028: name=etcd1 peerURLs=http://etcd1:2380 clientURLs=http://etcd1:2379 isLeader=false
postgres@patroni1:~$ exit

$ docker exec -ti demo-haproxy bash
postgres@haproxy:~$ psql -h localhost -p 5000 -U postgres -W
Password: postgres
psql (11.2 (Ubuntu 11.2-1.pgdg18.04+1), server 10.7 (Debian 10.7-1.pgdg90+1))
Type &quot;help&quot; for help.

localhost/postgres=# select pg_is_in_recovery();
 pg_is_in_recovery
───────────────────
 f
(1 row)

localhost/postgres=# \q

$postgres@haproxy:~ psql -h localhost -p 5001 -U postgres -W
Password: postgres
psql (11.2 (Ubuntu 11.2-1.pgdg18.04+1), server 10.7 (Debian 10.7-1.pgdg90+1))
Type &quot;help&quot; for help.

localhost/postgres=# select pg_is_in_recovery();
 pg_is_in_recovery
───────────────────
 t
(1 row)
</code></pre><h2 id="Citus-cluster"><a href="#Citus-cluster" class="headerlink" title="Citus cluster"></a>Citus cluster</h2><p>The stack starts three containers with etcd (forming a three-node etcd cluster), seven containers with Patroni+PostgreSQL+Citus (three coordinator nodes, and two worker clusters with two nodes each), and one container with haproxy.<br>The haproxy listens on ports 5000 (connects to the coordinator primary) and 5001 (does load-balancing between worker primary nodes).</p><p>Example session:</p><pre><code>$ docker-compose -f docker-compose-citus.yml up -d
Creating demo-work2-1 ... done
Creating demo-work1-1 ... done
Creating demo-etcd2   ... done
Creating demo-etcd1   ... done
Creating demo-coord3  ... done
Creating demo-etcd3   ... done
Creating demo-coord1  ... done
Creating demo-haproxy ... done
Creating demo-work2-2 ... done
Creating demo-coord2  ... done
Creating demo-work1-2 ... done

$ docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                              NAMES
852d8885a612   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 3 seconds                                      demo-coord3
cdd692f947ab   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 3 seconds                                      demo-work1-2
9f4e340b36da   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 3 seconds                                      demo-etcd3
d69c129a960a   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 4 seconds                                      demo-etcd1
c5849689b8cd   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 4 seconds                                      demo-coord1
c9d72bd6217d   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 3 seconds                                      demo-work2-1
24b1b43efa05   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 4 seconds                                      demo-coord2
cb0cc2b4ca0a   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 3 seconds                                      demo-work2-2
9796c6b8aad5   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 5 seconds                                      demo-work1-1
8baccd74dcae   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 4 seconds                                      demo-etcd2
353ec62a0187   patroni-citus          &quot;/bin/sh /entrypoint…&quot;   6 seconds ago   Up 4 seconds   0.0.0.0:5000-5001-&gt;5000-5001/tcp   demo-haproxy

$ docker logs demo-coord1
2023-01-05 15:09:31,295 INFO: Selected new etcd server http://172.27.0.4:2379
2023-01-05 15:09:31,388 INFO: Lock owner: None; I am coord1
2023-01-05 15:09:31,501 INFO: trying to bootstrap a new cluster
...
2023-01-05 15:09:45,096 INFO: postmaster pid=39
localhost:5432 - no response
2023-01-05 15:09:45.137 UTC [39] LOG:  starting PostgreSQL 15.1 (Debian 15.1-1.pgdg110+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 10.2.1-6) 10.2.1 20210110, 64-bit
2023-01-05 15:09:45.137 UTC [39] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432
2023-01-05 15:09:45.152 UTC [39] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;
2023-01-05 15:09:45.177 UTC [43] LOG:  database system was shut down at 2023-01-05 15:09:32 UTC
2023-01-05 15:09:45.193 UTC [39] LOG:  database system is ready to accept connections
localhost:5432 - accepting connections
localhost:5432 - accepting connections
2023-01-05 15:09:46,139 INFO: establishing a new patroni connection to the postgres cluster
2023-01-05 15:09:46,208 INFO: running post_bootstrap
2023-01-05 15:09:47.209 UTC [55] LOG:  starting maintenance daemon on database 16386 user 10
2023-01-05 15:09:47.209 UTC [55] CONTEXT:  Citus maintenance daemon for database 16386 user 10
2023-01-05 15:09:47,215 WARNING: Could not activate Linux watchdog device: &quot;Can&#39;t open watchdog device: [Errno 2] No such file or directory: &#39;/dev/watchdog&#39;&quot;
2023-01-05 15:09:47.446 UTC [41] LOG:  checkpoint starting: immediate force wait
2023-01-05 15:09:47,466 INFO: initialized a new cluster
2023-01-05 15:09:47,594 DEBUG: query(SELECT nodeid, groupid, nodename, nodeport, noderole FROM pg_catalog.pg_dist_node WHERE noderole = &#39;primary&#39;, ())
2023-01-05 15:09:47,594 INFO: establishing a new patroni connection to the postgres cluster
2023-01-05 15:09:47,467 INFO: Lock owner: coord1; I am coord1
2023-01-05 15:09:47,613 DEBUG: query(SELECT pg_catalog.citus_set_coordinator_host(%s, %s, &#39;primary&#39;, &#39;default&#39;), (&#39;172.27.0.6&#39;, 5432))
2023-01-05 15:09:47,924 INFO: no action. I am (coord1), the leader with the lock
2023-01-05 15:09:51.282 UTC [41] LOG:  checkpoint complete: wrote 1086 buffers (53.0%); 0 WAL file(s) added, 0 removed, 0 recycled; write=0.029 s, sync=3.746 s, total=3.837 s; sync files=280, longest=0.028 s, average=0.014 s; distance=8965 kB, estimate=8965 kB
2023-01-05 15:09:51.283 UTC [41] LOG:  checkpoint starting: immediate force wait
2023-01-05 15:09:51.495 UTC [41] LOG:  checkpoint complete: wrote 18 buffers (0.9%); 0 WAL file(s) added, 0 removed, 0 recycled; write=0.044 s, sync=0.091 s, total=0.212 s; sync files=15, longest=0.015 s, average=0.007 s; distance=67 kB, estimate=8076 kB
2023-01-05 15:09:57,467 INFO: Lock owner: coord1; I am coord1
2023-01-05 15:09:57,569 INFO: Assigning synchronous standby status to [&#39;coord3&#39;]
server signaled
2023-01-05 15:09:57.574 UTC [39] LOG:  received SIGHUP, reloading configuration files
2023-01-05 15:09:57.580 UTC [39] LOG:  parameter &quot;synchronous_standby_names&quot; changed to &quot;coord3&quot;
2023-01-05 15:09:59,637 INFO: Synchronous standby status assigned to [&#39;coord3&#39;]
2023-01-05 15:09:59,638 DEBUG: query(SELECT pg_catalog.citus_add_node(%s, %s, %s, &#39;primary&#39;, &#39;default&#39;), (&#39;172.27.0.2&#39;, 5432, 1))
2023-01-05 15:09:59.690 UTC [67] LOG:  standby &quot;coord3&quot; is now a synchronous standby with priority 1
2023-01-05 15:09:59.690 UTC [67] STATEMENT:  START_REPLICATION SLOT &quot;coord3&quot; 0/3000000 TIMELINE 1
2023-01-05 15:09:59,694 INFO: no action. I am (coord1), the leader with the lock
2023-01-05 15:09:59,704 DEBUG: query(SELECT pg_catalog.citus_add_node(%s, %s, %s, &#39;primary&#39;, &#39;default&#39;), (&#39;172.27.0.8&#39;, 5432, 2))
2023-01-05 15:10:07,625 INFO: no action. I am (coord1), the leader with the lock
2023-01-05 15:10:17,579 INFO: no action. I am (coord1), the leader with the lock

$ docker exec -ti demo-haproxy bash
postgres@haproxy:~$ etcdctl member list
1bab629f01fa9065, started, etcd3, http://etcd3:2380, http://172.27.0.10:2379
8ecb6af518d241cc, started, etcd2, http://etcd2:2380, http://172.27.0.4:2379
b2e169fcb8a34028, started, etcd1, http://etcd1:2380, http://172.27.0.7:2379

postgres@haproxy:~$ etcdctl get --keys-only --prefix /service/demo
/service/demo/0/config
/service/demo/0/initialize
/service/demo/0/leader
/service/demo/0/members/coord1
/service/demo/0/members/coord2
/service/demo/0/members/coord3
/service/demo/0/status
/service/demo/0/sync
/service/demo/1/config
/service/demo/1/initialize
/service/demo/1/leader
/service/demo/1/members/work1-1
/service/demo/1/members/work1-2
/service/demo/1/status
/service/demo/1/sync
/service/demo/2/config
/service/demo/2/initialize
/service/demo/2/leader
/service/demo/2/members/work2-1
/service/demo/2/members/work2-2
/service/demo/2/status
/service/demo/2/sync

postgres@haproxy:~$ psql -h localhost -p 5000 -U postgres -d citus
Password for user postgres: postgres
psql (15.1 (Debian 15.1-1.pgdg110+1))
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off)
Type &quot;help&quot; for help.

citus=# select pg_is_in_recovery();
 pg_is_in_recovery
-------------------
 f
(1 row)

citus=# table pg_dist_node;
 nodeid | groupid |  nodename  | nodeport | noderack | hasmetadata | isactive | noderole | nodecluster | metadatasynced | shouldhaveshards
--------+---------+------------+----------+----------+-------------+----------+----------+-------------+----------------+------------------
      1 |       0 | 172.27.0.6 |     5432 | default  | t           | t        | primary  | default     | t              | f
      2 |       1 | 172.27.0.2 |     5432 | default  | t           | t        | primary  | default     | t              | t
      3 |       2 | 172.27.0.8 |     5432 | default  | t           | t        | primary  | default     | t              | t
(3 rows)

citus=# \q

postgres@haproxy:~$ patronictl list
+ Citus cluster: demo ----------+--------------+---------+----+-----------+
| Group | Member  | Host        | Role         | State   | TL | Lag in MB |
+-------+---------+-------------+--------------+---------+----+-----------+
|     0 | coord1  | 172.27.0.6  | Leader       | running |  1 |           |
|     0 | coord2  | 172.27.0.5  | Replica      | running |  1 |         0 |
|     0 | coord3  | 172.27.0.9  | Sync Standby | running |  1 |         0 |
|     1 | work1-1 | 172.27.0.2  | Leader       | running |  1 |           |
|     1 | work1-2 | 172.27.0.12 | Sync Standby | running |  1 |         0 |
|     2 | work2-1 | 172.27.0.11 | Sync Standby | running |  1 |         0 |
|     2 | work2-2 | 172.27.0.8  | Leader       | running |  1 |           |
+-------+---------+-------------+--------------+---------+----+-----------+

postgres@haproxy:~$ patronictl switchover --group 2 --force
Current cluster topology
+ Citus cluster: demo (group: 2, 7185185529556963355) +-----------+
| Member  | Host        | Role         | State   | TL | Lag in MB |
+---------+-------------+--------------+---------+----+-----------+
| work2-1 | 172.27.0.11 | Sync Standby | running |  1 |         0 |
| work2-2 | 172.27.0.8  | Leader       | running |  1 |           |
+---------+-------------+--------------+---------+----+-----------+
2023-01-05 15:29:29.54204 Successfully switched over to &quot;work2-1&quot;
+ Citus cluster: demo (group: 2, 7185185529556963355) -------+
| Member  | Host        | Role    | State   | TL | Lag in MB |
+---------+-------------+---------+---------+----+-----------+
| work2-1 | 172.27.0.11 | Leader  | running |  1 |           |
| work2-2 | 172.27.0.8  | Replica | stopped |    |   unknown |
+---------+-------------+---------+---------+----+-----------+

postgres@haproxy:~$ patronictl list
+ Citus cluster: demo ----------+--------------+---------+----+-----------+
| Group | Member  | Host        | Role         | State   | TL | Lag in MB |
+-------+---------+-------------+--------------+---------+----+-----------+
|     0 | coord1  | 172.27.0.6  | Leader       | running |  1 |           |
|     0 | coord2  | 172.27.0.5  | Replica      | running |  1 |         0 |
|     0 | coord3  | 172.27.0.9  | Sync Standby | running |  1 |         0 |
|     1 | work1-1 | 172.27.0.2  | Leader       | running |  1 |           |
|     1 | work1-2 | 172.27.0.12 | Sync Standby | running |  1 |         0 |
|     2 | work2-1 | 172.27.0.11 | Leader       | running |  2 |           |
|     2 | work2-2 | 172.27.0.8  | Sync Standby | running |  2 |         0 |
+-------+---------+-------------+--------------+---------+----+-----------+

postgres@haproxy:~$ psql -h localhost -p 5000 -U postgres -d citus
Password for user postgres: postgres
psql (15.1 (Debian 15.1-1.pgdg110+1))
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off)
Type &quot;help&quot; for help.

citus=# table pg_dist_node;
 nodeid | groupid |  nodename   | nodeport | noderack | hasmetadata | isactive | noderole | nodecluster | metadatasynced | shouldhaveshards
--------+---------+-------------+----------+----------+-------------+----------+----------+-------------+----------------+------------------
      1 |       0 | 172.27.0.6  |     5432 | default  | t           | t        | primary  | default     | t              | f
      3 |       2 | 172.27.0.11 |     5432 | default  | t           | t        | primary  | default     | t              | t
      2 |       1 | 172.27.0.2  |     5432 | default  | t           | t        | primary  | default     | t              | t
(3 rows)
</code></pre></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="https://jackerzz.github.io">Jackerzz-zzk</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://jackerzz.github.io/posts/devops/ha/patroni_citus_ha.html">https://jackerzz.github.io/posts/devops/ha/patroni_citus_ha.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jackerzz.github.io" target="_blank">Jacker-zzk's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PostgreSQL/">PostgreSQL</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/3244513.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/devops/auto/work_flows.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/3408744.jpg" onerror='onerror=null,src="http://static.kongdf.com/bg4.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">自动化后台工作流</div></div></a></div><div class="next-post pull-right"><a href="/posts/devops/ha/qianyi.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/615299.jpg" onerror='onerror=null,src="http://static.kongdf.com/bg4.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">pgsql单机数据迁移到Citus构建的集群中</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/devops/ha/Haproxy_%20Patroni.html" title="Haproxy可以与Patroni配合"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/615299.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-05</div><div class="title">Haproxy可以与Patroni配合</div></div></a></div><div><a href="/posts/devops/ha/Patroni.html" title="Patroni介绍"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/2753432.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-13</div><div class="title">Patroni介绍</div></div></a></div><div><a href="/posts/devops/ha/PgBouncer.html" title="pgbouncer &amp; Haproxy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/1142950.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-14</div><div class="title">pgbouncer &amp; Haproxy</div></div></a></div><div><a href="/posts/devops/ha/ha_postgres.html" title="高可用PostgreSQL部署方案"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/1819651.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-05</div><div class="title">高可用PostgreSQL部署方案</div></div></a></div><div><a href="/posts/devops/ha/k8s_psql.html" title="Haproxy可以与Patroni配合"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/3560044.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-05</div><div class="title">Haproxy可以与Patroni配合</div></div></a></div><div><a href="/posts/devops/ha/pg_ha.html" title="Patroni+citus HA 验证"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/615299.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-13</div><div class="title">Patroni+citus HA 验证</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@sion1.0/images/avatar/35586448.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Jackerzz-zzk</div><div class="author-info__description">有趣的旅行</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">158</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">34</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jackerzz"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/jackerzz" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/miningrest1024@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">想赢,不一定用实力和本Q,最重要的是信心和胆识,放弃,就一定是输,尝试还有一半机会</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Dockerfile-and-Dockerfile-citus"><span class="toc-number">1.</span> <span class="toc-text">Dockerfile and Dockerfile.citus</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Examples"><span class="toc-number">2.</span> <span class="toc-text">Examples</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Standalone-Patroni"><span class="toc-number">2.1.</span> <span class="toc-text">Standalone Patroni</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Three-node-Patroni-cluster"><span class="toc-number">2.2.</span> <span class="toc-text">Three-node Patroni cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Citus-cluster"><span class="toc-number">2.3.</span> <span class="toc-text">Citus cluster</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/devops/ha/d.html" title="自定义封装的python 工具包"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/615299.jpg" onerror='this.onerror=null,this.src="http://static.kongdf.com/bg4.jpg"' alt="自定义封装的python 工具包"></a><div class="content"><a class="title" href="/posts/devops/ha/d.html" title="自定义封装的python 工具包">自定义封装的python 工具包</a><time datetime="2024-08-20T16:00:00.000Z" title="发表于 2024-08-21 00:00:00">2024-08-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/deepLearning/microservices.html" title="记录一下微服务下的物联网高可用系统架构技术方案"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/2579916.jpg" onerror='this.onerror=null,this.src="http://static.kongdf.com/bg4.jpg"' alt="记录一下微服务下的物联网高可用系统架构技术方案"></a><div class="content"><a class="title" href="/posts/deepLearning/microservices.html" title="记录一下微服务下的物联网高可用系统架构技术方案">记录一下微服务下的物联网高可用系统架构技术方案</a><time datetime="2024-07-22T13:37:17.000Z" title="发表于 2024-07-22 21:37:17">2024-07-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Grafana/dynamicText.html" title="Grafana中使用动态文本看板"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/777211.jpg" onerror='this.onerror=null,this.src="http://static.kongdf.com/bg4.jpg"' alt="Grafana中使用动态文本看板"></a><div class="content"><a class="title" href="/posts/Grafana/dynamicText.html" title="Grafana中使用动态文本看板">Grafana中使用动态文本看板</a><time datetime="2024-07-22T02:01:52.000Z" title="发表于 2024-07-22 10:01:52">2024-07-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Grafana/echarts.html" title="Grafana中使用Echarts实现大盘看板"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/3560044.jpg" onerror='this.onerror=null,this.src="http://static.kongdf.com/bg4.jpg"' alt="Grafana中使用Echarts实现大盘看板"></a><div class="content"><a class="title" href="/posts/Grafana/echarts.html" title="Grafana中使用Echarts实现大盘看板">Grafana中使用Echarts实现大盘看板</a><time datetime="2024-07-22T02:01:52.000Z" title="发表于 2024-07-22 10:01:52">2024-07-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/LLM/cost.html" title="Prompt Engineering co star framework(提示词工程架构)"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/jackerzz/jackerzz.github.io@ersion1.1/images/canva/3408744.jpg" onerror='this.onerror=null,this.src="http://static.kongdf.com/bg4.jpg"' alt="Prompt Engineering co star framework(提示词工程架构)"></a><div class="content"><a class="title" href="/posts/LLM/cost.html" title="Prompt Engineering co star framework(提示词工程架构)">Prompt Engineering co star framework(提示词工程架构)</a><time datetime="2024-07-12T15:01:52.000Z" title="发表于 2024-07-12 23:01:52">2024-07-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Jackerzz-zzk</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class="js-pjax"></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="IU,iu" data-fontsize="15px" data-random="false" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>